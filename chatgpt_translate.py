import re
from chatgpt import ChatGPT
from slack_sdk import WebClient
from slack_sdk.errors import SlackApiError


class ChatGPTTranslate(ChatGPT):
    def __init__(self, app, chatgpt_api_key, slack_client):
        super().__init__(app, chatgpt_api_key)
        self.slack_client = slack_client
        self.flag = {
          "ad": "アンドラ公国",
          "ae": "アラブ首長国連邦",
          "af": "アフガニスタン・イスラム国",
          "ag": "アンチグア・バーブーダ",
          "ai": "アンギラ",
          "al": "アルバニア共和国",
          "am": "アルメニア共和国",
          "an": "オランダ領アンティル",
          "ao": "アンゴラ共和国",
          "aq": "南極",
          "ar": "アルゼンチン共和国",
          "as": "米領サモア",
          "at": "オーストリア共和国",
          "au": "オーストラリア",
          "aw": "アルバ",
          "ax": "オーランド諸島",
          "az": "アゼルバイジャン共和国",
          "ba": "ボスニア・ヘルツェゴビナ",
          "bb": "バルバドス",
          "bd": "バングラデシュ人民共和国",
          "be": "ベルギー王国",
          "bf": "ブルキナファソ",
          "bg": "ブルガリア共和国",
          "bh": "バーレーン王国",
          "bi": "ブルンジ共和国",
          "bj": "ベナン共和国",
          "bl": "サン・バルテルミー島",
          "bm": "バミューダ諸島",
          "bn": "ブルネイ・ダルサラーム国",
          "bo": "ボリビア多民族国",
          "bq": "英領南極地域",
          "br": "ブラジル連邦共和国",
          "bs": "バハマ国",
          "bt": "ブータン王国",
          "bu": "ビルマ連邦社会主義共和国",
          "bv": "ブーベ島",
          "bw": "ボツワナ共和国",
          "by": "ベラルーシ共和国",
          "bz": "ベリーズ",
          "ca": "カナダ",
          "cc": "ココス諸島",
          "cd": "コンゴ民主共和国",
          "cf": "中央アフリカ共和国",
          "cg": "コンゴ共和国",
          "ch": "スイス連邦",
          "ci": "コートジボアール共和国",
          "ck": "クック諸島",
          "cl": "チリ共和国",
          "cm": "カメルーン共和国",
          "cn": "中華人民共和国",
          "co": "コロンビア共和国",
          "cr": "コスタリカ共和国",
          "cs": "セルビア・モンテネグロ",
          "ct": "カントン島・エンダーバリ島",
          "cu": "キューバ共和国",
          "cv": "カーボベルデ共和国",
          "cx": "クリスマス島",
          "cy": "キプロス共和国",
          "cz": "チェコ共和国",
          "dd": "ドイツ民主共和国",
          "de": "ドイツ連邦共和国",
          "dj": "ジブチ共和国",
          "dk": "デンマーク王国",
          "dm": "ドミニカ国",
          "do": "ドミニカ共和国",
          "dy": "ダホメ共和国",
          "dz": "アルジェリア民主人民共和国",
          "ec": "エクアドル共和国",
          "ee": "エストニア共和国",
          "eg": "エジプト・アラブ共和国",
          "eh": "西サハラ",
          "er": "エリトリア国",
          "es": "スペイン",
          "et": "エチオピア連邦民主共和国",
          "fi": "フィンランド共和国",
          "fj": "フィジー諸島共和国",
          "fk": "フォークランド(マルビナス)諸島",
          "fm": "ミクロネシア連邦",
          "fo": "フェロー諸島",
          "fq": "仏領諸島",
          "fr": "フランス共和国",
          "fx": "フランス本国",
          "ga": "ガボン共和国",
          "gb": "グレートブリテンおよび北部アイルランド連合王国(英国)",
          "gd": "グレナダ",
          "ge": "ジョージア",
          "gf": "フランス領ギアナ",
          "gg": "ガーンジー島",
          "gh": "ガーナ共和国",
          "gi": "ジブラルタル",
          "gl": "グリーンランド",
          "gm": "ガンビア共和国",
          "gn": "ギニア共和国",
          "gp": "グアドループ島",
          "gq": "赤道ギニア共和国",
          "gr": "ギリシア共和国",
          "gs": "南ジョージア島・南サンドイッチ諸島",
          "gt": "グアテマラ共和国",
          "gu": "グアム",
          "gw": "ギニアビサウ共和国",
          "gy": "ガイアナ協同共和国",
          "hk": "香港特別行政区(ホンコン)",
          "hm": "ヘアド島・マクドナルド諸島",
          "hn": "ホンジュラス共和国",
          "hr": "クロアチア共和国",
          "ht": "ハイチ共和国",
          "hu": "ハンガリー共和国",
          "hv": "オートボルタ共和国",
          "id": "インドネシア共和国",
          "ie": "アイルランド",
          "il": "イスラエル国",
          "im": "マン島",
          "in": "インド",
          "io": "英領インド洋地域",
          "iq": "イラク共和国",
          "ir": "イラン・イスラム共和国",
          "is": "アイスランド共和国",
          "it": "イタリア共和国",
          "je": "ジャージー島",
          "jm": "ジャマイカ",
          "jo": "ヨルダン・ハシミテ王国",
          "jp": "日本国",
          "jt": "ジョンストン島",
          "ke": "ケニア共和国",
          "kg": "キルギス共和国",
          "kh": "カンボジア王国",
          "ki": "キリバス共和国",
          "km": "コモロ連合",
          "kn": "セントクリストファー・ネイビス",
          "kp": "(北朝鮮=朝鮮民主主義人民共和国)",
          "kr": "大韓民国",
          "kw": "クウェート国",
          "ky": "ケイマン諸島",
          "kz": "カザフスタン共和国",
          "la": "ラオス人民民主共和国",
          "lb": "レバノン共和国",
          "lc": "セントルシア",
          "li": "リヒテンシュタイン公国",
          "lk": "スリランカ民主社会主義共和国",
          "lr": "リベリア共和国",
          "ls": "レソト王国",
          "lt": "リトアニア共和国",
          "lu": "ルクセンブルク大公国",
          "lv": "ラトビア共和国",
          "ly": "社会主義人民リビア・アラブ国",
          "ma": "モロッコ王国",
          "mc": "モナコ公国",
          "md": "モルドバ共和国",
          "me": "モンテネグロ",
          "mf": "サン・マルタン島",
          "mg": "マダガスカル共和国",
          "mh": "マーシャル諸島共和国",
          "mi": "ミッドウェー諸島",
          "mk": "マケドニア旧ユーゴスラビア共和国",
          "ml": "マリ共和国",
          "mm": "ミャンマー連邦",
          "mn": "モンゴル国",
          "mo": "マカオ(澳門)",
          "mp": "北マリアナ諸島",
          "mq": "マルチニーク島",
          "mr": "モーリタニア・イスラム共和国",
          "ms": "モンセラット",
          "mt": "マルタ共和国",
          "mu": "モーリシャス共和国",
          "mv": "モルディヴ共和国",
          "mw": "マラウイ共和国",
          "mx": "メキシコ合衆国",
          "my": "マレーシア",
          "mz": "モザンビーク共和国",
          "na": "ナミビア共和国",
          "nc": "ニューカレドニア",
          "ne": "ニジェール共和国",
          "nf": "ノーフォーク島",
          "ng": "ナイジェリア連邦共和国",
          "nh": "ニューヘブリデス",
          "ni": "ニカラグア共和国",
          "nl": "オランダ王国",
          "no": "ノルウェー王国",
          "np": "ネパール連邦民主共和国",
          "nq": "ドロニング・マウド",
          "nr": "ナウル共和国",
          "nt": "中立地帯",
          "nu": "ニウエ",
          "nz": "ニュージーランド",
          "om": "オマーン国",
          "pa": "パナマ共和国",
          "pc": "太平洋諸島信託統治地域",
          "pe": "ペルー共和国",
          "pf": "フランス領ポリネシア",
          "pg": "パプアニューギニア",
          "ph": "フィリピン共和国",
          "pk": "パキスタン・イスラム共和国",
          "pl": "ポーランド共和国",
          "pm": "サンピエール島・ミクロン島",
          "pn": "ピトケアン島",
          "pr": "プエルトリコ",
          "ps": "パレスチナ占領区域",
          "pt": "ポルトガル共和国",
          "pu": "米領太平洋諸島",
          "pw": "パラオ共和国",
          "py": "パラグアイ共和国",
          "qa": "カタール国",
          "re": "レユニオン",
          "rh": "南ローデシア",
          "ro": "ルーマニア",
          "rs": "セルビア共和国",
          "ru": "ロシア連邦",
          "rw": "ルワンダ共和国",
          "sa": "サウジアラビア王国",
          "sb": "ソロモン諸島",
          "sc": "セイシェル共和国",
          "sd": "スーダン共和国",
          "se": "スウェーデン王国",
          "sg": "シンガポール共和国",
          "sh": "セントヘレナ島",
          "si": "スロベニア共和国",
          "sj": "スバールバル諸島・ヤンマイエン島",
          "sk": "スロバキア共和国",
          "sl": "シエラレオネ共和国",
          "sm": "サンマリノ共和国",
          "sn": "セネガル共和国",
          "so": "ソマリア民主共和国",
          "sr": "スリナム共和国",
          "st": "サントメ・プリンシペ民主共和国",
          "su": "ソビエト社会主義共和国連邦",
          "sv": "エルサルバドル共和国",
          "sy": "シリア・アラブ共和国",
          "sz": "スワジランド王国",
          "tc": "タークス諸島・カイコス諸島",
          "td": "チャド共和国",
          "tf": "フランス領極南諸島",
          "tg": "トーゴ共和国",
          "th": "タイ王国",
          "tj": "タジキスタン共和国",
          "tk": "トケラウ諸島",
          "tl": "東ティモール民主共和国",
          "tm": "トルクメニスタン",
          "tn": "チュニジア共和国",
          "to": "トンガ王国",
          "tp": "東ティモール",
          "tr": "トルコ共和国",
          "tt": "トリニダード・トバゴ共和国",
          "tv": "ツバル",
          "tw": "タイワン(台湾)",
          "tz": "タンザニア連合共和国",
          "ua": "ウクライナ",
          "ug": "ウガンダ共和国",
          "um": "米領太平洋諸島",
          "us": "アメリカ合衆国(米国)",
          "uy": "ウルグアイ東方共和国",
          "uz": "ウズベキスタン共和国",
          "va": "バチカン市国",
          "vc": "セントビンセントおよびグレナディーン諸島",
          "vd": "ベトナム民主共和国",
          "ve": "ベネズエラ・ボリバル共和国",
          "vg": "英領バージン諸島",
          "vi": "米領バージン諸島",
          "vn": "ベトナム社会主義共和国",
          "vu": "バヌアツ共和国",
          "wf": "ワリス・フテュナ諸島",
          "wk": "ウェーク島",
          "ws": "サモア独立国",
          "xx": "出版地不明",
          "yd": "イエメン民主人民共和国",
          "ye": "イエメン共和国",
          "yt": "マイヨット島",
          "yu": "ユーゴスラビア連邦共和国",
          "za": "南アフリカ共和国",
          "zm": "ザンビア共和国",
          "zr": "ザイール共和国",
          "zw": "ジンバブエ共和国",
        }

    def reaction(self, event, say):
        emoji = event["reaction"]
        channel = event["item"]["channel"]
        ts = event["item"]["ts"]

        re_emoji = re.findall('flag-(.*)$', emoji)
        if len(re_emoji) > 0:
            emoji = re_emoji[0]

        if emoji not in self.flag:
            return

        country = self.flag[emoji]

        print(country)

        # タイムスタンプでメッセージを特定
        conversations_history = self.slack_client.conversations_history(
            channel=channel, oldest=ts, latest=ts, inclusive=1
        )

        messages = conversations_history.data["messages"]

        # メッセージが取得出来ない場合、スレッドからメッセージを特定
        if not messages:
            group_history = self.slack_client.conversations_replies(channel=channel, ts=ts)
            messages = group_history.data["messages"]

        chatgpt_message = [
            {"role": "system", "content": f"""
あなたは通訳です。
質問の内容を{country}の公用語に翻訳して返答してください。
返答は翻訳した内容だけにしてください
"""},
            {"role": "user", "content": messages[0]["text"]},
        ]

        answer = self.chatgpt(chatgpt_message)
        print(answer)

        say(text=answer, thread_ts=ts)



